# State Machine Transitions with History

Write mutations that implement a state machine for a support ticket system. This will test your understanding of:
1. State transitions
2. State history tracking
3. Role-based permissions
4. Audit logging

## Schema

Create a schema with these tables:

1. "tickets" table:
   - `title`: string (required) - Ticket title
   - `description`: string (required) - Ticket description
   - `priority`: string (required) - One of: "low", "medium", "high", "urgent"
   - `status`: string (required) - One of: "new", "assigned", "in_progress", "blocked", "resolved", "closed"
   - `assigneeId`: Id<"users"> (optional) - Currently assigned user
   - `createdBy`: Id<"users"> (required) - User who created the ticket
   - `createdAt`: number (required) - Creation timestamp
   - `updatedAt`: number (required) - Last update timestamp
   - `dueDate`: number (optional) - When ticket needs to be resolved
   - `tags`: array of strings (optional) - Ticket tags

2. "stateChanges" table:
   - `ticketId`: Id<"tickets"> (required) - Reference to ticket
   - `fromState`: string (required) - Previous status
   - `toState`: string (required) - New status
   - `userId`: Id<"users"> (required) - User who made the change
   - `timestamp`: number (required) - When change occurred
   - `comment`: string (optional) - Note about the change
   - `metadata`: object (optional) - Additional change data:
     - `reason`: string (optional) - Why the change was made
     - `blockedBy`: string (optional) - If status is "blocked"
     - `resolution`: string (optional) - If status is "resolved"

3. "users" table:
   - `name`: string (required) - User's name
   - `role`: string (required) - One of: "user", "agent", "admin"
   - `active`: boolean (required) - Whether user is active

## Required Functions

Write a mutation called `updateTicketStatus` that:

1. Takes these arguments:
   - `ticketId`: Id<"tickets"> - Ticket to update
   - `newStatus`: string - Desired status
   - `comment`: string (optional) - Note about change
   - `metadata`: object (optional) - Additional data

2. Validates that:
   - Ticket exists
   - User has permission for the transition
   - Transition is valid per state machine rules
   - Required metadata is provided for certain states

3. State Machine Rules:
   - "new" → "assigned": Requires agent/admin role
   - "assigned" → "in_progress": Only assignee can start
   - Any → "blocked": Requires reason in metadata
   - Any → "resolved": Requires resolution in metadata
   - "resolved" → "closed": Auto-closes after 24h if no issues
   - "closed" → Any: Only admin can reopen

4. Returns:
   - Updated ticket document
   - New state change record
   - Previous state for reference

## Example Usage

```typescript
// Success case - assign ticket
const result = await client.mutation("updateTicketStatus", {
  ticketId: existingId,
  newStatus: "assigned",
  comment: "Assigning to Alice",
  metadata: {
    assigneeId: aliceId
  }
});
// Returns: { 
//   ticket: { status: "assigned", ... },
//   stateChange: { fromState: "new", toState: "assigned", ... },
//   previousState: "new"
// }

// Error case - invalid transition
await client.mutation("updateTicketStatus", {
  ticketId: existingId,
  newStatus: "closed",  // Can't close without resolving
  comment: "Closing ticket"
}); 
// Throws: "Invalid transition: tickets must be resolved before closing"
```

## Test Cases

Your implementation should handle:

1. Valid Transitions:
   - New → Assigned (with agent)
   - Assigned → In Progress (with assignee)
   - Any → Blocked (with reason)
   - Any → Resolved (with resolution)
   - Resolved → Closed (after delay)

2. Invalid Transitions:
   - New → Closed
   - Blocked → Closed
   - Closed → Any (without admin)
   - Missing required metadata

3. Permission Checks:
   - Regular user limitations
   - Agent permissions
   - Admin override abilities

4. State History:
   - Complete transition log
   - Metadata preservation
   - Comment tracking

5. Business Rules:
   - Auto-closure timing
   - Required fields per state
   - Role restrictions